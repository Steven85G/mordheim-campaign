<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campanya de Mordheim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('./fondo-mordheim1.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 280px;
            max-height: 300px;
        }
        @media (min-width: 640px) {
            .chart-container {
                height: 320px;
                max-height: 350px;
            }
        }
        @media (min-width: 1024px) {
            .lg\:col-span-2 ~ aside .chart-container {
                height: 280px;
            }
        }
    </style>
</head>
<body class="text-stone-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white-700"></h1><br><br><br><br>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-blue-700 mb-3 sm:mb-0">Classificació de les Bandes</h2>
                    <div class="flex items-center space-x-2">
                        <label for="faction-filter" class="text-sm font-medium text-stone-600">Filtrar per tipus de Banda:</label>
                        <select id="faction-filter" class="bg-stone-50 border border-stone-300 text-stone-900 text-sm rounded-lg focus:ring-slate-500 focus:border-slate-500 block w-full sm:w-auto p-2">
                            <option value="all">Totes les bandes</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-stone-500">
                        <thead class="text-xs text-blue-700 uppercase bg-stone-50">
                            <tr>
                                <th scope="col" class="px-3 py-3 rounded-l-lg">#</th>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Jugador</th>
                                <th scope="col" class="px-4 py-3 whitespace-nowrap">Banda</th>
                                <th scope="col" class="px-4 py-3 text-center">Valor</th>
                                <th scope="col" class="px-4 py-3 text-center" title="Victorias">V</th>
                                <th scope="col" class="px-4 py-3 text-center" title="Derrotas">D</th>
                                <th scope="col" class="px-4 py-3 text-center rounded-r-lg" title="Puntos">P</th>
                            </tr>
                        </thead>
                        <tbody id="warbands-table-body">
                            </tbody>
                    </table>
                </div>
                <p id="no-results" class="text-center text-stone-600 mt-8 hidden">No s'han trobat bandes per el tipus de banda seleccionada.</p>
                <div class="mt-8 bg-stone-100 rounded-lg shadow-inner p-4 notes-carousel">
                    <h3 class="text-lg font-bold text-blue-700 mb-3">Comentaris de les Bandes</h3>
                    <div id="note-display" class="min-h-[6rem] flex flex-col justify-center text-center transition-opacity duration-1000">
                        <p class="text-base italic text-stone-800" id="current-note">Preparant el primer comentari...</p>
                        <p class="text-sm font-semibold text-blue-600 mt-2" id="current-warband">-</p>
                    </div>
                </div>
            </div>

            <aside class="space-y-6 sm:space-y-8">
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <h3 class="text-lg sm:text-xl font-bold text-blue-700 mb-4">Estadístiques de la Campanya</h3>
                    <p class="text-xs sm:text-sm text-stone-800 mb-4">Resum visual de l'estat de la campanya. Fes servir el filtre per explorar per tipus de banda.</p>
                    <div class="grid grid-cols-2 gap-3 sm:gap-4 text-center">
                        <div class="bg-stone-50 p-3 rounded-lg">
                            <p class="text-xl sm:text-2xl font-bold text-blue-700" id="total-warbands">-</p>
                            <p class="text-xs font-medium text-stone-600 uppercase">Nº de Bandes</p>
                        </div>
                        <div class="bg-stone-50 p-3 rounded-lg">
                            <p class="text-xl sm:text-2xl font-bold text-blue-700" id="total-games">-</p>
                            <p class="text-xs font-medium text-stone-600 uppercase">Partides Totals</p>
                        </div>
                        <div class="bg-stone-50 p-3 rounded-lg col-span-2">
                            <p class="text-xl sm:text-2xl font-bold text-blue-700" id="avg-rating">-</p>
                            <p class="text-xs font-medium text-stone-600 uppercase">Valor de Banda Mitjà</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <h3 class="text-lg sm:text-xl font-bold text-blue-700 mb-2">Activitat dels Jugadors</h3>
                    <div class="chart-container">
                        <canvas id="player-games-chart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <h3 class="text-lg sm:text-xl font-bold text-blue-700 mb-2">Ranking per Valor de Banda</h3>
                    <div class="chart-container">
                        <canvas id="rating-chart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <h3 class="text-lg sm:text-xl font-bold text-blue-700 mb-2">Top 5 Rendiment en Batalla</h3>
                    <div class="chart-container">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <h3 class="text-lg sm:text-xl font-bold text-blue-700 mb-2">Distrctes més Disputats</h3>
                    <div class="chart-container">
                        <canvas id="district-chart"></canvas>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- DATOS DE LA CAMPAÑA ---
            // ... (Tu array warbandsData, gamesData) ...
            const warbandsData = [
                { player: 'Gerard', name: 'Sons of Minas Mórgül', faction: 'Orkos Negros', rating: 299, wins: 4, losses: 13, notes: 'Em parlez a mi? Waaaaaagh!' },
                { player: 'Gerard2', name: 'Whololoo', faction: 'Poseidos', rating: 459, wins: 0, losses: 0, notes: 'Inofensius seguidors del senyor de les ombres' },
                { player: 'Gerard3', name: 'Norses', faction: 'Exploradores Nórdicos', rating: 352, wins: 0, losses: 0, notes: 'Només et robarem una mica, potser et matem i ens fotem tot beure que porteu' },
                { player: 'Gerard4', name: 'Wich Hunters', faction: 'Cazadores de Brujas', rating: 327, wins: 0, losses: 0, notes: 'Magia? A la fogueraa! St Joan is a nice day' },
                { player: 'Gerard5', name: 'Zaraky Sons', faction: 'Bárbaros del Caos', rating: 283, wins: 0, losses: 1, notes: 'Només el camí de la sang et porta al nirvana imbécil' },
                { player: 'Uri', name: 'Garrapatos Kaos Style', faction: 'Góblins', rating: 111, wins: 0, losses: 1, notes: 'La casa es en flames, is fine' },
                { player: 'Uri2', name: 'Rebenta Flancs', faction: 'Hombres Bestia', rating: 150, wins: 0, losses: 0, notes: 'Mireu cap aquí que així no veureu que passa per allà' },
                { player: 'Uri3', name: 'Els Robavides', faction: 'Muertos Sin Descanso', rating: 150, wins: 0, losses: 0, notes: 'Et robo la vida i marxo, em persegueixes et robo una altre vida i torno a marxar' },
                { player: 'Víctor', name: 'Tribu Trencaossos', faction: 'Ogros', rating: 190, wins: 2, losses: 7, notes: 'Abracem arbres... Per matar-te amb ells!' },
                { player: 'Víctor2', name: 'La Pitjor Generació', faction: 'Piratas', rating: 159, wins: 0, losses: 2, notes: '¡Rayos y truenos! ¿Donde está el Ron?' },
                { player: 'Víctor3', name: 'Secta de Malekiz', faction: 'Elfos Oscuros', rating: 400, wins: 0, losses: 0, notes: 'Vine, et vui comentar algo en aquell racó darrere aquella ombra gens sospitosa' },
                { player: 'Ivan', name: 'Garden Circus', faction: 'Feria Ambulante del Caos', rating: 199, wins: 6, losses: 2, notes: 'Som bona gent, però potser mors durant les funcions' },
                { player: 'Ivan2', name: 'Barbes Llargues', faction: 'Enanos', rating: 350, wins: 0, losses: 0, notes: 'Hem vingut a cobrar agrabis, però multiplicats per dos' },
                { player: 'Ivan3', name: 'Lady Von Carstein', faction: 'No Muertos', rating: 250, wins: 0, losses: 0, notes: 'Les caricies de la nostra Vampira et deixaràn garratibat' },
                { player: 'Ivan4', name: 'Valhalla', faction: 'Exploradores Nórdicos', rating: 250, wins: 0, losses: 0, notes: 'Destrals, escuts i enemics, no necessitem més' },
                { player: 'Ivan5', name: 'Pestilens', faction: 'Skavens', rating: 150, wins: 0, losses: 0, notes: 'Correm com rates però algún dia aguantarem més que els nans' },
                { player: 'Carles', name: 'Tripielfs', faction: 'Elfos Oscuros', rating: 400, wins: 0, losses: 0, notes: 'Som de fiar tranquils, però passeu vosaltres al davant' },
                { player: 'Carles2', name: 'Gladiators Rage', faction: 'Luchadores del Pozo', rating: 241, wins: 3, losses: 2, notes: 'Ara que ja som lliures... Ja podeu començar a correr!' },
                { player: 'Carles3', name: 'Cola Filosas Eshin', faction: 'Skavens', rating: 200, wins: 0, losses: 0, notes: 'Lluitar? Aneu passant que nosaltres ara venim...' },
                { player: 'Albert', name: 'Desamparats', faction: 'No Muertos', rating: 253, wins: 3, losses: 6, notes: 'Esteu tots convidats a sopar... No cal que porteu res...' },
                { player: 'Albert2', name: 'Crazy Catai Warriors', faction: 'Monges Gerreros de Catai', rating: 181, wins: 0, losses: 5, notes: 'Aloz tles delicies? Atrapam si pots' },
                { player: 'Albert3', name: 'Clan Escut de Roure', faction: 'Enanos', rating: 200, wins: 0, losses: 0, notes: 'Anem a poc a poc, però procura que no deixar-te veure' },
                { player: 'Albert4', name: 'Liche Team', faction: 'Muertos Sin Descanso', rating: 150, wins: 0, losses: 0, notes: 'Un zombie amaga una sorpresa per tu' },
                { player: 'Albert5', name: 'Minotauro Crush', faction: 'Hombres Bestia', rating: 100, wins: 0, losses: 0, notes: 'Aparteu-vos perque nosaltres no frenem' },
            ];
            
            const gamesData = [
                { id: 1, players: ['Gerard', 'Ivan', 'Carles', 'Albert'], district: 'El Cementerio' },
                { id: 2, players: ['Gerard', 'Ivan', 'Carles', 'Albert'], district: 'Estatua del Conde Gotthard' },
                { id: 3, players: ['Gerard', 'Ivan', 'Carles', 'Taquru'], district: 'La Cárcel' },
                { id: 4, players: ['Gerard', 'Ivan'], district: 'Muelle' },
                { id: 5, players: ['Gerard', 'Victor'], district: 'Cuartel del Cuervo' },
                { id: 6, players: ['Gerard', 'Victor', 'Ivan'], district: 'Pequeño Moot' },
                { id: 7, players: ['Gerard', 'Victor', 'Albert'], district: 'La Cárcel' },
                { id: 8, players: ['Gerard', 'Ivan', 'Carles', 'Taquru', 'Albert', 'Victor'], district: 'Plaza del Mercado' },
                { id: 9, players: ['Gerard', 'Albert', 'Victor'], district: 'La Roca' },
                { id: 10, players: ['Gerard', 'Albert', 'Carles'], district: 'Estatua del Conde Gotthard' },
                { id: 11, players: ['Gerard', 'Albert', 'Victor'], district: 'La Cárcel' },
                { id: 12, players: ['Gerard', 'Albert', 'Carles'], district: 'Plaza del Verdugo' },
                { id: 13, players: ['Gerard', 'Albert2', 'Carles2'], district: 'Cuartel del Cuervo' },
                { id: 14, players: ['Gerard', 'Ivan'], district: 'Anfiteatro' },
                { id: 15, players: ['Gerard', 'Albert2', 'Carles2', 'Victor'], district: 'La Gran Biblioteca' },
                { id: 16, players: ['Gerard', 'Albert2', 'Carles2', 'Victor'], district: 'Barrio de los Ricos' },
                { id: 17, players: ['Victor2', 'Albert2', 'Carles2'], district: 'Barrio Pobre' },
                { id: 18, players: ['Gerard', 'Albert2', 'Carles2', 'Victor2'], district: 'Barrio Pobre' },
                { id: 19, players: ['Gerard5', 'Uri', 'Victor'], district: 'Puente Central' },
            ];
    
            // --- NUEVO ESTADO PARA JEFES DE ZONA ---
            const BOSSES = [
                'Roble Bestia',
                'Conde Steinhardt',
                'Quimera',
                "Be'lakor"
            ];
    
            // Definimos el estado inicial
            const initialBossKillsData = {
                'Roble Bestia': null,
                'Conde Steinhardt': null,
                'Quimera': null,
                "Be'lakor": null,
            };
    
            // Función para cargar los datos del localStorage o usar el estado inicial
            function loadBossKills() {
                try {
                    const savedData = localStorage.getItem('bossKillsData');
                    if (savedData) {
                        return JSON.parse(savedData);
                    }
                } catch (e) {
                    console.error("Error cargando bossKillsData de localStorage:", e);
                }
                return initialBossKillsData;
            }
    
            // Función para guardar los datos en localStorage
            function saveBossKills(data) {
                try {
                    localStorage.setItem('bossKillsData', JSON.stringify(data));
                } catch (e) {
                    console.error("Error guardando bossKillsData en localStorage:", e);
                }
            }
    
            // Cargamos el estado al inicio
            let bossKillsData = loadBossKills();
    
            // --- ESTADO Y ELEMENTOS DE LA APLICACIÓN ---
            let ratingChart, playerGamesChart, districtChart;
            const factionFilter = document.getElementById('faction-filter');
            const tableBody = document.getElementById('warbands-table-body');
            const noResultsMessage = document.getElementById('no-results');
    
            function init() {
                populateFactionFilter();
                factionFilter.addEventListener('change', render);
                render();
                initNotesCarousel();
            }
    
            function render() {
                const filteredData = getFilteredData();
                renderTable(filteredData);
                updateDashboardStats(filteredData);
                renderCharts(filteredData);
                renderBossKills(); // Aseguramos que se llama al renderizado de los Jefes
            }
            
            // --- FUNCIONES DE GRÁFICOS Y UTILIDADES EXISTENTES (SIN MODIFICAR) ---
            
            function getFilteredData() {
                const selectedFaction = factionFilter.value;
                if (selectedFaction === 'all') {
                    return [...warbandsData];
                }
                return warbandsData.filter(wb => wb.faction === selectedFaction);
            }
    
            function populateFactionFilter() {
                const factions = [...new Set(warbandsData.map(wb => wb.faction).filter(f => f))];
                factions.sort().forEach(faction => {
                    const option = document.createElement('option');
                    option.value = faction;
                    option.textContent = faction;
                    factionFilter.appendChild(option);
                });
            }
    
            function renderTable(data) {
                tableBody.innerHTML = '';
                
                if(data.length === 0){
                    noResultsMessage.classList.remove('hidden');
                    return;
                }
                noResultsMessage.classList.add('hidden');
    
                const sortedData = [...data].sort((a, b) => {
                    const pointsA = (a.wins * 3) + a.losses;
                    const pointsB = (b.wins * 3) + b.losses;
                    
                    if (pointsB !== pointsA) {
                        return pointsB - pointsA;
                    }
                    return b.wins - a.wins;
                });
    
                sortedData.forEach((wb, index) => {
                    const points = (wb.wins * 3) + wb.losses;
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-stone-50';
                    row.innerHTML = `
                        <td class="px-3 py-4 font-medium text-stone-900">${index + 1}</td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="font-bold">${wb.name || 'Sin nombre'}</div>
                            <div class="text-xs text-stone-500">${wb.player}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">${wb.faction || 'Sin facción'}</td>
                        <td class="px-4 py-4 text-center">${wb.rating}</td>
                        <td class="px-4 py-4 text-center font-bold text-green-600">${wb.wins}</td>
                        <td class="px-4 py-4 text-center font-bold text-red-600">${wb.losses}</td>
                        <td class="px-4 py-4 text-center font-bold text-blue-700">${points}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            function updateDashboardStats(data) {
                const activeWarbands = data.filter(wb => wb.name && wb.faction && wb.rating > 0);
                const totalWarbands = activeWarbands.length;
                const totalRating = activeWarbands.reduce((acc, wb) => acc + wb.rating, 0);
                const avgRating = totalWarbands > 0 ? Math.round(totalRating / totalWarbands) : 0;
                
                let totalGames;
                const selectedFaction = factionFilter.value;
    
                if (selectedFaction === 'all') {
                    totalGames = gamesData.length;
                } else {
                    const filteredPlayers = data.map(wb => wb.player);
                    const factionGames = gamesData.filter(game => 
                        game.players.some(playerInGame => filteredPlayers.includes(playerInGame))
                    );
                    totalGames = factionGames.length;
                }
                
                document.getElementById('total-warbands').textContent = totalWarbands;
                document.getElementById('total-games').textContent = totalGames;
                document.getElementById('avg-rating').textContent = avgRating;
            }
    
            function renderCharts(data) {
                renderPlayerGamesChart(warbandsData);
                renderRatingChart(data.filter(wb => wb.name && wb.rating > 0));
                renderDistrictChart();
            }
            
            function renderPlayerGamesChart(data) {
                const playerData = data.map(wb => ({
                    player: wb.player,
                    games: wb.wins + wb.losses
                }));
    
                const playerNames = [...new Set(data.map(wb => wb.player.replace(/\d+$/, '')))];
                const playerGamesMap = playerData.reduce((acc, p) => {
                    const baseName = p.player.replace(/\d+$/, '');
                    acc[baseName] = (acc[baseName] || 0) + p.games;
                    return acc;
                }, {});
    
                const labels = playerNames.filter(name => playerGamesMap[name] > 0);
                const counts = labels.map(name => playerGamesMap[name]);
    
                const BASE_COLORS = {
                    'Gerard': 'rgba(255, 99, 132, 1)', 
                    'Uri': 'rgba(54, 162, 235, 1)',   
                    'Víctor': 'rgba(255, 206, 86, 1)', 
                    'Ivan': 'rgba(75, 192, 192, 1)', 
                    'Carles': 'rgba(153, 102, 255, 1)',
                    'Albert': 'rgba(255, 159, 64, 1)',
                    'default': 'rgba(128, 128, 128, 1)' 
                };
    
                const backgroundColors = labels.map(name => BASE_COLORS[name] || BASE_COLORS['default']);
    
    
                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Partides Jugades',
                        data: counts,
                        backgroundColor: backgroundColors,
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                };
    
                if (playerGamesChart) playerGamesChart.destroy();
                playerGamesChart = new Chart(document.getElementById('player-games-chart'), {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }
    
            function renderDistrictChart() {
                const districtCounts = gamesData.reduce((acc, game) => {
                    if (game.district) {
                        acc[game.district] = (acc[game.district] || 0) + 1;
                    }
                    return acc;
                }, {});
                const sortedDistricts = Object.entries(districtCounts).sort(([,a],[,b]) => b-a);
                const labels = sortedDistricts.map(([district]) => district);
                const counts = sortedDistricts.map(([,count]) => count);
    
                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Nº de Partides',
                        data: counts,
                        backgroundColor: 'rgba(65, 105, 225, 1)',
                        borderColor: 'rgba(55, 65, 81, 1)',
                        borderWidth: 1
                    }]
                };
    
                if (districtChart) districtChart.destroy();
                districtChart = new Chart(document.getElementById('district-chart'), {
                    type: 'bar',
                    data: chartData,
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
    
            function renderRatingChart(data) {
                const sortedData = [...data].sort((a, b) => b.rating - a.rating);
                const labels = sortedData.map(wb => wb.name);
                const ratings = sortedData.map(wb => wb.rating);
                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Valor de Banda',
                        data: ratings,
                        backgroundColor: 'rgba(65, 105, 225, 1)',
                        borderColor: 'rgba(65, 105, 225, 1)',
                        borderWidth: 1
                    }]
                };
                if (ratingChart) ratingChart.destroy();
                ratingChart = new Chart(document.getElementById('rating-chart'), {
                    type: 'bar',
                    data: chartData,
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true } }
                    }
                });
            }
            
            // --- FUNCIONES MODIFICADAS PARA JEFES DE ZONA CON LOCALSTORAGE ---
    
            function renderBossKills() {
                const tableBody = document.getElementById('boss-kills-table-body');
                tableBody.innerHTML = '';
                
                BOSSES.forEach(boss => {
                    const killer = bossKillsData[boss];
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-stone-50';
                    row.innerHTML = `
                        <td class="px-4 py-3 font-semibold text-stone-900">${boss}</td>
                        <td class="px-4 py-3 text-center font-bold ${killer ? 'text-green-600' : 'text-red-500'}">
                            ${killer || 'VIU'}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
    
            window.editBossKill = function() {
                const bossList = BOSSES.join(', ');
                const bossToEdit = prompt(`Escriu el nom del Jefe de Zona a actualitzar: (${bossList})`);
    
                if (bossToEdit && BOSSES.includes(bossToEdit)) {
                    const currentKiller = bossKillsData[bossToEdit];
                    
                    let newKiller = prompt(`Introdueix el nom de la Banda que ha eliminat a ${bossToEdit}.\n\n(Deixa-ho buit per marcar-lo com a VIU)`);
                    
                    // Si newKiller es null (cancelar) o una cadena vacía (marcar como vivo), usa null.
                    newKiller = newKiller ? newKiller.trim() : null;
    
                    if (newKiller === currentKiller) {
                        alert(`El Jefe ${bossToEdit} ja té el valor "${currentKiller || 'VIU'}". No s'han fet canvis.`);
                        return;
                    }
    
                    // 1. Actualizar el estado en memoria
                    bossKillsData[bossToEdit] = newKiller;
                    
                    // 2. Guardar el nuevo estado en localStorage
                    saveBossKills(bossKillsData);
    
                    // 3. Volver a renderizar la tabla para mostrar los cambios
                    renderBossKills();
                    alert(`El Jefe ${bossToEdit} ha estat actualitzat. Nova Banda Eliminadora: ${newKiller || 'VIU'}`);
    
                } else if (bossToEdit) {
                    alert(`El nom del Jefe de Zona no és vàlid. Els Jefes són: ${bossList}`);
                }
            }
            
            // --- FUNCIONES DE CARRUSEL EXISTENTES (SIN MODIFICAR) ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            function initNotesCarousel() {
                const notes = warbandsData
                    .filter(wb => wb.notes && wb.notes.trim() !== '')
                    .map(wb => ({ note: wb.notes, warband: wb.name }));
                
                if (notes.length === 0) return;
    
                const shuffledNotes = shuffleArray(notes);
                const displayElement = document.getElementById('note-display');
                const noteP = document.getElementById('current-note');
                const warbandP = document.getElementById('current-warband');
                let currentIndex = 0;
                const intervalTime = 120000; // 2 minutos en milisegundos
    
                function showNextNote() {
                    // Fade out
                    displayElement.style.opacity = 0;
    
                    setTimeout(() => {
                        // Update content
                        const currentNoteData = shuffledNotes[currentIndex];
                        noteP.textContent = `"${currentNoteData.note}"`;
                        warbandP.textContent = `- ${currentNoteData.warband}`;
    
                        // Fade in
                        displayElement.style.opacity = 1;
                        
                        // Increment index, loop to start, and re-shuffle if necessary
                        currentIndex++;
                        if (currentIndex >= shuffledNotes.length) {
                            currentIndex = 0;
                            shuffleArray(shuffledNotes); // Re-shuffle for a new random order
                        }
                    }, 1000); // Wait for the fade out transition (1000ms from CSS)
                }
    
                // Start the carousel immediately, then set the interval
                showNextNote();
                setInterval(showNextNote, intervalTime);
            }
    
            init();
        });
    </script>
</body>
</html>

